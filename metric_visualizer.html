<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GPU Benchmark Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    :root {
      --bg: #f5f5f5;
      --card: #ffffff;
      --accent: #58508d; /* Using the primary brand color */
      --text: #0f172a;
      --muted: #6b7280;
      --border: #d1d5db;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); }
    #app { max-width: 1280px; margin: 0 auto; padding: 20px 16px 40px; }
    
    /* Typography */
    h1 { font-size: 1.8rem; margin: 0 0 4px; font-weight: 700; color: #1e293b; }
    .subtitle { font-size: 0.9rem; color: var(--muted); margin-bottom: 20px; }

    /* Tabs */
    .tab-bar { display: flex; flex-wrap: wrap; gap: 2px; margin-bottom: 0; border-bottom: 1px solid var(--border); }
    .tab-button {
      padding: 10px 16px; border: 1px solid transparent; border-bottom: none; border-radius: 6px 6px 0 0;
      background: transparent; color: var(--muted); cursor: pointer; font-weight: 500; font-size: 0.9rem;
      margin-bottom: -1px; transition: all 0.2s;
    }
    .tab-button:hover { color: var(--accent); background: rgba(255,255,255,0.5); }
    .tab-button.active { background: var(--card); color: var(--accent); border-color: var(--border); border-bottom-color: var(--card); }
    
    .tab-content { display: none; background: var(--card); border: 1px solid var(--border); border-top: none; padding: 20px; border-radius: 0 0 6px 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .tab-content.active { display: block; }

    /* Controls Grid */
    .controls-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; margin-bottom: 20px; align-items: end; }
    .control-group { display: flex; flex-direction: column; gap: 6px; }
    .control-group label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--muted); letter-spacing: 0.03em; }
    
    /* Standard Select */
    select.std-select {
      width: 100%; padding: 8px 12px; border-radius: 4px; border: 1px solid var(--border);
      background: #fff; font-size: 0.85rem; color: var(--text); outline: none; cursor: pointer;
    }
    select.std-select:focus { border-color: var(--accent); }

    /* Multi Select Component */
    .multi-select { position: relative; font-size: 0.85rem; user-select: none; }
    .ms-display {
      border: 1px solid var(--border); background: #fff; padding: 8px 30px 8px 12px;
      border-radius: 4px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      position: relative; transition: border-color 0.15s;
    }
    .ms-display:hover { border-color: #9ca3af; }
    .ms-display.active { border-color: var(--accent); }
    .ms-display::after { content: "â–¾"; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 0.8em; }
    
    .ms-dropdown {
      position: absolute; top: 100%; left: 0; width: 100%; z-index: 50;
      background: #fff; border: 1px solid var(--border); border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 4px;
      max-height: 250px; overflow-y: auto; display: none;
    }
    .ms-dropdown.open { display: block; }
    .ms-option { display: flex; align-items: center; gap: 8px; padding: 6px 12px; cursor: pointer; transition: background 0.1s; }
    .ms-option:hover { background: #f3f4f6; }
    .ms-option input { margin: 0; cursor: pointer; }

    /* Chart Area */
    .chart-container { min-height: 500px; width: 100%; position: relative; }
    
    /* Summary Box */
    .summary-box {
      margin-top: 15px; padding: 12px; background: #f8fafc; border: 1px solid var(--border); border-radius: 6px;
      display: flex; flex-direction: column; gap: 8px;
    }
    .summary-title { font-size: 0.8rem; font-weight: 700; color: var(--muted); text-transform: uppercase; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
    .summary-item { font-size: 0.85rem; }
    .summary-item strong { color: var(--text); font-weight: 600; }
    .summary-val { font-family: monospace; background: #e2e8f0; padding: 2px 6px; border-radius: 3px; }

    .alert { padding: 12px; background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; border-radius: 4px; font-size: 0.9rem; display: none; margin-bottom: 10px; }
  </style>
</head>
<body>

<div id="app">
  <h1>GPU Benchmark Explorer</h1>
  <div class="subtitle">Interactive performance analysis for LLaMA Inference (FP16/INT4), Toy Training, and Diffusion.</div>

  <div class="tab-bar">
    <button class="tab-button active" onclick="switchTab('tab-8b')">8B LLaMA 3.1 (FP16)</button>
    <button class="tab-button" onclick="switchTab('tab-70b')">70B LLaMA 3.1 Quantized (INT4)</button>
    <button class="tab-button" onclick="switchTab('tab-train')">Training (Toy)</button>
    <button class="tab-button" onclick="switchTab('tab-diff')">Diffusion</button>
  </div>

  <div id="tab-8b" class="tab-content active">
    <div class="alert" id="alert-8b"></div>
    <div class="controls-row">
      <div class="control-group">
        <label>Metric</label>
        <select id="metric-8b" class="std-select">
          <option value="Req_per_Sec">Requests / Sec</option>
          <option value="Tokens_per_Sec" selected>Tokens / Sec</option>
          <option value="Output_Tokens_per_Sec">Output Tokens / Sec</option>
        </select>
      </div>
      <div class="control-group" id="ctrl-8b-gpu"></div> 
      <div class="control-group" id="ctrl-8b-batch"></div>
      <div class="control-group" id="ctrl-8b-p2p"></div>
    </div>
    <div id="chart-8b" class="chart-container"></div>
    <div id="sum-8b" class="summary-box" style="display:none"></div>
  </div>

  <div id="tab-70b" class="tab-content">
    <div class="alert" id="alert-70b"></div>
    <div class="controls-row">
      <div class="control-group">
        <label>Metric</label>
        <select id="metric-70b" class="std-select">
          <option value="Req_per_Sec">Requests / Sec</option>
          <option value="Tokens_per_Sec" selected>Tokens / Sec</option>
          <option value="Output_Tokens_per_Sec">Output Tokens / Sec</option>
        </select>
      </div>
      <div class="control-group" id="ctrl-70b-gpu"></div>
      <div class="control-group" id="ctrl-70b-batch"></div>
      <div class="control-group" id="ctrl-70b-p2p"></div>
    </div>
    <div id="chart-70b" class="chart-container"></div>
    <div id="sum-70b" class="summary-box" style="display:none"></div>
  </div>

  <div id="tab-train" class="tab-content">
    <div class="alert" id="alert-train"></div>
    <div class="controls-row">
      <div class="control-group">
        <label>Metric</label>
        <select id="metric-train" class="std-select">
          <option value="Throughput" selected>Throughput (samples/s)</option>
          <option value="Latency">Latency (ms)</option>
          <option value="Peak_VRAM">Peak VRAM (GB)</option>
          <option value="BW_Est">Est. Bandwidth (GB/s)</option>
        </select>
      </div>
      <div class="control-group" id="ctrl-train-gpu"></div>
      <div class="control-group" id="ctrl-train-mode"></div>
      <div class="control-group" id="ctrl-train-batch"></div>
      <div class="control-group" id="ctrl-train-seq"></div>
      <div class="control-group" id="ctrl-train-p2p"></div>
    </div>
    <div id="chart-train" class="chart-container"></div>
    <div id="sum-train" class="summary-box" style="display:none"></div>
  </div>

  <div id="tab-diff" class="tab-content">
    <div class="alert" id="alert-diff"></div>
    <div class="controls-row">
      <div class="control-group">
        <label>Metric</label>
        <select id="metric-diff" class="std-select">
          <option value="it_s">Iterations / Sec</option>
        </select>
      </div>
      <div class="control-group" id="ctrl-diff-gpu"></div>
      <div class="control-group" id="ctrl-diff-model"></div>
    </div>
    <div id="chart-diff" class="chart-container"></div>
    <div id="sum-diff" class="summary-box" style="display:none"></div>
  </div>
</div>

<script>
/**
 * DATA PLACEHOLDERS
 */
const CSV_8B = `GPU,TP,Batch,P2P_Enabled,Req_per_Sec,Tokens_per_Sec,Output_Tokens_per_Sec
a6000,1,1,YES,6.32,4856.17,1618.72
a6000,1,32,YES,6.16,4730.15,1576.72
a6000,2,1,YES,9.75,7484.88,2494.96
a6000,2,1,NO,7.43,5704.34,1901.45
a6000,2,32,YES,9.52,7310.91,2436.97
a6000,2,32,NO,7.39,5672.85,1890.95
a100_80_sxm4x8,1,1,YES,13.55,10406.56,3468.85
a100_80_sxm4x8,1,32,YES,13.52,10386.61,3462.20
a100_80_sxm4x8,2,1,YES,20.12,15455.15,5151.72
a100_80_sxm4x8,2,1,NO,7.57,5810.21,1936.74
a100_80_sxm4x8,2,32,YES,19.93,15302.76,5100.92
a100_80_sxm4x8,2,32,NO,7.74,5945.31,1981.77
a100_80_sxm4x8,4,1,YES,26.17,20101.00,6700.33
a100_80_sxm4x8,4,1,NO,7.05,5416.92,1805.64
a100_80_sxm4x8,4,32,YES,25.97,19948.24,6649.41
a100_80_sxm4x8,4,32,NO,7.35,5641.36,1880.45
a100_80_sxm4x8,8,1,YES,27.84,21377.33,7125.78
a100_80_sxm4x8,8,1,NO,1.67,1286.19,428.73
a100_80_sxm4x8,8,32,YES,28.26,21704.47,7234.82
a100_80_sxm4x8,8,32,NO,1.67,1281.72,427.24
rtx6000S,1,1,YES,16.04,12321.97,4107.32
rtx6000S,1,32,YES,16.02,12305.25,4101.75
rtx6000S,2,1,YES,19.65,15089.22,5029.74
rtx6000S,2,32,YES,19.94,15315.49,5105.16
rtx6000S,4,1,YES,22.54,17309.65,5769.88
rtx6000S,4,32,YES,22.63,17376.03,5792.01
rtx6000S,8,1,YES,20.83,15995.21,5331.74
rtx6000S,8,32,YES,20.85,16016.50,5338.83
v100_sxm2x4,1,1,YES,2.41,1852.01,617.34
v100_sxm2x4,1,32,YES,2.40,1846.57,615.52
v100_sxm2x4,2,1,YES,5.03,3861.49,1287.16
v100_sxm2x4,2,1,NO,4.08,3135.25,1045.08
v100_sxm2x4,2,32,YES,5.58,4285.67,1428.56
v100_sxm2x4,2,32,NO,4.07,3126.18,1042.06
v100_sxm2x4,4,1,YES,7.97,6122.39,2040.80
v100_sxm2x4,4,1,NO,3.54,2716.82,905.61
v100_sxm2x4,4,32,YES,9.49,7285.59,2428.53
v100_sxm2x4,4,32,NO,3.54,2719.68,906.56`;
const CSV_70B = `GPU,TP,Batch,P2P_Enabled,Req_per_Sec,Tokens_per_Sec,Output_Tokens_per_Sec
a6000_80,1,1,YES,0.50,385.75,128.58
a6000_80,1,32,YES,0.50,385.72,128.57
a6000_80,2,1,YES,1.37,1049.02,349.67
a6000_80,2,1,NO,1.13,871.06,290.35
a6000_80,2,32,YES,1.37,1053.13,351.04
a6000_80,2,32,NO,1.14,873.36,291.12
a100_80_sxm4x8_70,1,1,YES,1.29,992.80,330.93
a100_80_sxm4x8_70,1,32,YES,1.29,993.55,331.18
a100_80_sxm4x8_70,2,1,YES,2.96,2270.98,756.99
a100_80_sxm4x8_70,2,1,NO,1.44,1107.27,369.09
a100_80_sxm4x8_70,2,32,YES,2.96,2270.95,756.98
a100_80_sxm4x8_70,2,32,NO,1.41,1084.85,361.62
a100_80_sxm4x8_70,4,1,YES,4.94,3790.18,1263.39
a100_80_sxm4x8_70,4,1,NO,1.54,1182.08,394.03
a100_80_sxm4x8_70,4,32,YES,4.95,3799.74,1266.58
a100_80_sxm4x8_70,4,32,NO,1.50,1149.30,383.10
a100_80_sxm4x8_70,8,1,YES,7.56,5802.84,1934.28
a100_80_sxm4x8_70,8,1,NO,0.41,312.15,104.05
a100_80_sxm4x8_70,8,32,YES,7.58,5824.41,1941.47
a100_80_sxm4x8_70,8,32,NO,0.41,315.12,105.04
rtx6000S_80,1,1,YES,1.47,1127.96,375.99
rtx6000S_80,1,32,YES,2.45,1877.78,625.93
rtx6000S_80,2,1,YES,3.94,3022.23,1007.41
rtx6000S_80,2,32,YES,3.94,3026.13,1008.71
v100_sxm2x4_70,1,1,YES,OOM/FAIL,,
v100_sxm2x4_70,1,32,YES,OOM/FAIL,,
v100_sxm2x4_70,2,1,YES,0.52,403.05,134.35
v100_sxm2x4_70,2,1,NO,0.44,335.49,111.83
v100_sxm2x4_70,2,32,YES,0.53,404.32,134.77
v100_sxm2x4_70,2,32,NO,0.44,337.53,112.51
v100_sxm2x4_70,4,1,YES,1.53,1171.69,390.56
v100_sxm2x4_70,4,1,NO,0.70,540.11,180.04
v100_sxm2x4_70,4,32,YES,1.56,1199.75,399.92
v100_sxm2x4_70,4,32,NO,0.70,540.12,180.04`;
const CSV_TRAIN = `GPU,Mode,Num_GPUs,Global_Batch,Seq_Len,P2P_Enabled,Throughput,Latency,Peak_VRAM,BW_Est
a6000,ddp,1,16,256,YES,5968.37,686.28,26.46,14.87
a6000,ddp,2,16,256,YES,9903.18,413.60,24.39,24.67
a6000,ddp,2,16,256,NO,4578.13,894.69,24.39,11.40
a6000,fsdp,2,16,256,YES,8317.16,492.48,14.99,31.07
a6000,fsdp,2,16,256,NO,2960.44,1383.58,14.99,11.06
a6000,tp,2,16,256,YES,8169.56,250.69,9.94,3.21
a6000,tp,2,16,256,NO,6454.09,317.32,9.94,2.54
a6000,ddp,2,32,256,YES,10597.94,772.98,26.46,13.20
a6000,ddp,2,32,256,NO,7229.64,1133.11,26.46,9.00
a6000,fsdp,2,32,256,YES,10189.93,803.93,16.27,19.03
a6000,fsdp,2,32,256,NO,5719.74,1432.23,16.27,10.68
a6000,tp,2,32,256,YES,10145.87,403.71,11.11,3.99
a6000,tp,2,32,256,NO,7581.37,540.27,11.11,2.98
a6000,ddp,2,64,256,YES,12124.66,1472.76,32.65,6.93
a6000,ddp,2,64,256,NO,9985.84,1640.72,32.65,6.22
a6000,fsdp,2,64,256,YES,11958.25,1370.10,19.89,11.17
a6000,fsdp,2,64,256,NO,8901.20,1840.65,19.89,8.31
a6000,tp,2,64,256,YES,11520.31,711.09,14.46,4.53
a6000,tp,2,64,256,NO,8269.05,990.68,14.46,3.25
a6000,ddp,2,128,256,YES,OOM/Fail,,,
a6000,ddp,2,128,256,NO,OOM/Fail,,,
a6000,fsdp,2,128,256,YES,12811.85,2557.63,28.14,5.98
a6000,fsdp,2,128,256,NO,10933.64,2996.99,28.14,5.11
a6000,tp,2,128,256,YES,12496.16,1311.12,21.14,4.91
a6000,tp,2,128,256,NO,8696.74,1883.92,21.14,3.42
a6000,ddp,2,256,256,YES,OOM/Fail,,,
a6000,ddp,2,256,256,NO,OOM/Fail,,,
a6000,fsdp,2,256,256,YES,OOM/Fail,,,
a6000,fsdp,2,256,256,NO,OOM/Fail,,,
a6000,tp,2,256,256,YES,12976.59,2525.16,34.52,5.10
a6000,tp,2,256,256,NO,8925.12,3671.43,34.52,3.51
a6000,tp,2,16,1024,YES,9804.45,835.54,24.96,3.86
a6000,tp,2,16,1024,NO,7240.38,1131.43,24.96,2.85
a6000,tp,2,16,2048,YES,OOM/Fail,,,
a6000,tp,2,16,2048,NO,OOM/Fail,,,
a6000,tp,2,16,4096,YES,OOM/Fail,,,
a6000,tp,2,16,4096,NO,OOM/Fail,,,
a100_80_sxm4x8,ddp,1,16,256,YES,14083.58,290.84,26.46,35.08
a100_80_sxm4x8,ddp,2,16,256,YES,24003.45,170.64,24.39,59.79
a100_80_sxm4x8,ddp,2,16,256,NO,2896.70,1414.02,24.39,7.21
a100_80_sxm4x8,fsdp,2,16,256,YES,23289.86,175.87,14.99,87.01
a100_80_sxm4x8,fsdp,2,16,256,NO,1729.49,2368.33,14.99,6.46
a100_80_sxm4x8,tp,2,16,256,YES,23890.82,85.72,9.94,9.39
a100_80_sxm4x8,tp,2,16,256,NO,7978.36,256.69,9.94,3.14
a100_80_sxm4x8,ddp,2,32,256,YES,26944.23,304.04,26.46,33.55
a100_80_sxm4x8,ddp,2,32,256,NO,5553.01,1475.24,26.46,6.92
a100_80_sxm4x8,fsdp,2,32,256,YES,27924.71,293.36,16.27,52.16
a100_80_sxm4x8,fsdp,2,32,256,NO,3462.48,2365.93,16.27,6.47
a100_80_sxm4x8,tp,2,32,256,YES,27081.27,151.25,11.11,10.65
a100_80_sxm4x8,tp,2,32,256,NO,8029.97,510.09,11.11,3.16
a100_80_sxm4x8,ddp,4,16,256,YES,36813.26,111.26,23.83,91.69
a100_80_sxm4x8,ddp,4,16,256,NO,2379.03,1721.71,23.83,5.93
a100_80_sxm4x8,fsdp,4,16,256,YES,34912.51,117.32,10.69,130.43
a100_80_sxm4x8,fsdp,4,16,256,NO,1549.42,2643.58,10.69,5.79
a100_80_sxm4x8,tp,4,16,256,YES,32704.70,31.31,4.84,25.72
a100_80_sxm4x8,tp,4,16,256,NO,7063.21,144.98,4.84,5.55
a100_80_sxm4x8,ddp,4,64,256,YES,53437.43,306.60,26.46,33.27
a100_80_sxm4x8,ddp,4,64,256,NO,8876.94,1845.68,26.46,5.53
a100_80_sxm4x8,fsdp,4,64,256,YES,56053.44,292.29,12.71,52.35
a100_80_sxm4x8,fsdp,4,64,256,NO,5698.67,2875.06,12.71,5.32
a100_80_sxm4x8,tp,4,64,256,YES,46677.57,87.75,5.94,36.71
a100_80_sxm4x8,tp,4,64,256,NO,7598.56,539.05,5.94,5.98
a100_80_sxm4x8,ddp,8,16,256,YES,44127.17,92.82,23.79,109.91
a100_80_sxm4x8,ddp,8,16,256,NO,398.27,10284.39,23.79,0.99
a100_80_sxm4x8,fsdp,8,16,256,YES,43727.54,93.67,8.54,163.37
a100_80_sxm4x8,fsdp,8,16,256,NO,419.99,9752.62,8.54,1.57
a100_80_sxm4x8,tp,8,16,256,YES,28882.06,17.73,2.42,45.43
a100_80_sxm4x8,tp,8,16,256,NO,1537.02,333.11,2.42,2.42
a100_80_sxm4x8,ddp,8,128,256,YES,105005.82,312.06,26.46,32.69
a100_80_sxm4x8,ddp,8,128,256,NO,3176.87,10314.55,26.46,0.99
a100_80_sxm4x8,fsdp,8,128,256,YES,112047.18,292.45,10.92,52.33
a100_80_sxm4x8,fsdp,8,128,256,NO,2722.65,12035.34,10.92,1.27
a100_80_sxm4x8,tp,8,128,256,YES,74541.38,54.95,3.42,117.24
a100_80_sxm4x8,tp,8,128,256,NO,1563.78,2619.29,3.42,2.46
a100_80_sxm4x8,ddp,8,64,256,YES,92491.59,177.14,24.39,57.59
a100_80_sxm4x8,ddp,8,64,256,NO,1610.77,10171.55,24.39,1.00
a100_80_sxm4x8,fsdp,8,64,256,YES,93634.33,174.98,9.55,87.46
a100_80_sxm4x8,fsdp,8,64,256,NO,1572.76,10417.34,9.55,1.47
a100_80_sxm4x8,tp,8,64,256,YES,62384.94,32.83,2.67,98.12
a100_80_sxm4x8,tp,8,64,256,NO,2182.67,938.30,2.67,3.43
a100_80_sxm4x8,ddp,8,128,256,YES,104851.34,312.52,26.46,32.64
a100_80_sxm4x8,ddp,8,128,256,NO,3182.49,10296.35,26.46,0.99
a100_80_sxm4x8,fsdp,8,128,256,YES,111926.28,292.76,10.92,52.27
a100_80_sxm4x8,fsdp,8,128,256,NO,3118.20,10508.63,10.92,1.46
a100_80_sxm4x8,tp,8,128,256,YES,74472.04,55.00,3.42,117.13
a100_80_sxm4x8,tp,8,128,256,NO,1556.85,2630.95,3.42,2.45
a100_80_sxm4x8,ddp,8,256,256,YES,112058.86,584.84,32.65,17.44
a100_80_sxm4x8,ddp,8,256,256,NO,6614.46,9907.99,32.65,1.03
a100_80_sxm4x8,fsdp,8,256,256,YES,121882.35,537.70,14.55,28.46
a100_80_sxm4x8,fsdp,8,256,256,NO,5329.90,12295.91,14.55,1.24
a100_80_sxm4x8,tp,8,256,256,YES,79709.08,102.77,5.05,125.37
a100_80_sxm4x8,tp,8,256,256,NO,1472.90,5561.81,5.05,2.32
a100_80_sxm4x8,tp,8,16,1024,YES,56026.20,36.55,3.31,88.12
a100_80_sxm4x8,tp,8,16,1024,NO,1433.10,1429.07,3.31,2.25
a100_80_sxm4x8,tp,8,16,2048,YES,56796.87,72.12,6.42,89.33
a100_80_sxm4x8,tp,8,16,2048,NO,1545.45,2650.37,6.42,2.43
a100_80_sxm4x8,tp,8,16,4096,YES,45919.43,178.40,17.88,72.23
a100_80_sxm4x8,tp,8,16,4096,NO,1458.79,5615.62,17.88,2.29
rtx6000S,ddp,1,16,256,YES,15209.02,269.31,26.46,37.88
rtx6000S,ddp,2,16,256,YES,17376.36,235.72,24.39,43.28
rtx6000S,fsdp,2,16,256,YES,14480.33,282.87,14.99,54.10
rtx6000S,tp,2,16,256,YES,18956.53,108.04,9.94,7.45
rtx6000S,ddp,2,32,256,YES,26237.32,312.23,26.46,32.67
rtx6000S,fsdp,2,32,256,YES,24158.76,339.09,16.27,45.13
rtx6000S,tp,2,32,256,YES,22680.44,180.60,11.11,8.92
rtx6000S,ddp,4,16,256,YES,15683.94,261.16,23.83,39.06
rtx6000S,fsdp,4,16,256,YES,11117.23,368.44,10.69,41.53
rtx6000S,tp,4,16,256,YES,22193.68,46.14,4.84,17.45
rtx6000S,ddp,4,64,256,YES,43041.07,380.66,26.46,26.80
rtx6000S,fsdp,4,64,256,YES,39746.14,412.22,12.71,37.12
rtx6000S,tp,4,64,256,YES,31929.64,128.28,5.94,25.11
rtx6000S,ddp,8,16,256,YES,11829.77,346.25,23.79,29.46
rtx6000S,fsdp,8,16,256,YES,8885.49,460.98,8.54,33.20
rtx6000S,tp,8,16,256,YES,20225.97,25.31,2.42,31.81
rtx6000S,ddp,8,128,256,YES,67677.06,484.18,26.46,21.07
rtx6000S,fsdp,8,128,256,YES,66098.01,495.75,10.92,30.87
rtx6000S,tp,8,128,256,YES,34468.33,118.83,3.42,54.21
rtx6000S,ddp,8,64,256,YES,40838.14,401.19,24.39,25.43
rtx6000S,fsdp,8,64,256,YES,34632.43,473.08,9.55,32.35
rtx6000S,tp,8,64,256,YES,31881.35,64.24,2.67,50.15
rtx6000S,ddp,8,128,256,YES,67960.10,482.17,26.46,21.16
rtx6000S,fsdp,8,128,256,YES,66184.55,495.10,10.92,30.91
rtx6000S,tp,8,128,256,YES,34475.87,118.81,3.42,54.23
rtx6000S,ddp,8,256,256,YES,99318.83,659.85,32.65,15.46
rtx6000S,fsdp,8,256,256,YES,106334.48,616.32,14.55,24.83
rtx6000S,tp,8,256,256,YES,36223.10,226.15,5.05,56.97
rtx6000S,tp,8,16,1024,YES,29999.68,68.27,3.31,47.19
rtx6000S,tp,8,16,2048,YES,29501.84,138.84,6.42,46.40
rtx6000S,tp,8,16,4096,YES,26747.42,306.27,17.88,42.07
v100_sxm2x4,ddp,1,16,256,YES,4597.49,890.92,26.46,11.45
v100_sxm2x4,ddp,2,16,256,YES,7891.67,519.03,24.39,19.66
v100_sxm2x4,ddp,2,16,256,NO,2606.45,1571.49,24.39,6.49
v100_sxm2x4,fsdp,2,16,256,YES,7866.77,520.67,14.99,29.39
v100_sxm2x4,fsdp,2,16,256,NO,1791.34,2286.55,14.99,6.69
v100_sxm2x4,tp,2,16,256,YES,9626.34,212.75,9.94,3.79
v100_sxm2x4,tp,2,16,256,NO,5754.58,355.89,9.94,2.26
v100_sxm2x4,ddp,2,32,256,YES,8721.41,939.30,26.46,10.86
v100_sxm2x4,ddp,2,32,256,NO,4439.01,1845.46,26.46,5.53
v100_sxm2x4,fsdp,2,32,256,YES,8950.27,915.28,16.27,16.72
v100_sxm2x4,fsdp,2,32,256,NO,3516.77,2329.41,16.27,6.57
v100_sxm2x4,tp,2,32,256,YES,10443.70,392.20,11.11,4.11
v100_sxm2x4,tp,2,32,256,NO,6008.61,681.69,11.11,2.36
v100_sxm2x4,ddp,4,16,256,YES,12174.97,336.43,23.83,30.32
v100_sxm2x4,ddp,4,16,256,NO,1259.10,3253.13,23.83,3.14
v100_sxm2x4,fsdp,4,16,256,YES,13706.72,298.83,10.69,51.21
v100_sxm2x4,fsdp,4,16,256,NO,802.83,5101.93,10.69,3.00
v100_sxm2x4,tp,4,16,256,YES,15202.39,67.36,4.84,11.96
v100_sxm2x4,tp,4,16,256,NO,3922.96,261.03,4.84,3.09
v100_sxm2x4,ddp,4,64,256,YES,17403.93,941.40,26.46,10.84
v100_sxm2x4,ddp,4,64,256,NO,4556.50,3595.75,26.46,2.84
v100_sxm2x4,fsdp,4,64,256,YES,20539.81,797.67,12.71,19.18
v100_sxm2x4,fsdp,4,64,256,NO,3159.10,5186.28,12.71,2.95
v100_sxm2x4,tp,4,64,256,YES,20133.31,203.44,5.94,15.83
v100_sxm2x4,tp,4,64,256,NO,4229.37,968.47,5.94,3.33
v100_sxm2x4,ddp,4,64,256,YES,17321.36,945.88,26.46,10.79
v100_sxm2x4,ddp,4,64,256,NO,4532.18,3615.04,26.46,2.82
v100_sxm2x4,fsdp,4,64,256,YES,20514.23,798.67,12.71,19.16
v100_sxm2x4,fsdp,4,64,256,NO,3160.32,5184.28,12.71,2.95
v100_sxm2x4,tp,4,64,256,YES,20122.73,203.55,5.94,15.83
v100_sxm2x4,tp,4,64,256,NO,4229.02,968.55,5.94,3.33
v100_sxm2x4,ddp,4,128,256,YES,OOM/Fail,,,
v100_sxm2x4,ddp,4,128,256,NO,OOM/Fail,,,
v100_sxm2x4,fsdp,4,128,256,YES,21261.36,1541.20,16.33,9.93
v100_sxm2x4,fsdp,4,128,256,NO,6188.35,5295.11,16.33,2.89
v100_sxm2x4,tp,4,128,256,YES,21340.19,383.88,7.99,16.78
v100_sxm2x4,tp,4,128,256,NO,4305.00,1902.91,7.99,3.39
v100_sxm2x4,ddp,4,256,256,YES,OOM/Fail,,,
v100_sxm2x4,ddp,4,256,256,NO,OOM/Fail,,,
v100_sxm2x4,fsdp,4,256,256,YES,17330.28,3781.59,24.58,4.05
v100_sxm2x4,fsdp,4,256,256,NO,11471.20,5713.09,24.58,2.68
v100_sxm2x4,tp,4,256,256,YES,21436.17,764.32,12.33,16.86
v100_sxm2x4,tp,4,256,256,NO,4316.97,3795.25,12.33,3.40
v100_sxm2x4,tp,4,16,1024,YES,17442.25,234.83,8.56,13.72
v100_sxm2x4,tp,4,16,1024,NO,4095.96,1000.01,8.56,3.22
v100_sxm2x4,tp,4,16,2048,YES,15672.58,522.70,20.24,12.33
v100_sxm2x4,tp,4,16,2048,NO,4008.17,2043.83,20.24,3.15
v100_sxm2x4,tp,4,16,4096,YES,OOM/Fail,,,
v100_sxm2x4,tp,4,16,4096,NO,OOM/Fail,,,`;
const CSV_DIFF = `GPU,sdxl_speed,z-image_speed
a6000,4.2,1.08
v100_sxm,3.208,0.944
rtx6000S,10.666,3.038
a100_80_sxm,8.042,2.164`;

// --- CONFIGURATION & UTILS ---

const GPU_NAMES = {
  'v100_sxm2x4': 'V100', 'v100_sxm2x4_70': 'V100', 'v100_sxm': 'V100',
  'a100_80_sxm4x8': 'A100', 'a100_80_sxm4x8_70': 'A100', 'a100_80_sxm': 'A100',
  'a6000': 'A6000', 'a6000_80': 'A6000',
  'rtx6000S': 'RTX 6000 Server', 'rtx6000S_80': 'RTX 6000 Ada'
};

// New Color Palette
// 0: 1 GPU/Model 1, 1: 2 GPU/Model 2, etc.
const PALETTE = [
    //{ norm: '#58508d', light: 'rgba(88, 80, 141, 0.35)' }, // Purple
	{ norm: '#58508d', light: '#58508d' }, // Purple - fixed because 1 GPU is always "enabled"
    { norm: '#bc5090', light: 'rgba(188, 80, 144, 0.35)' }, // Pink/Magenta
    { norm: '#d94c4c', light: 'rgba(255, 99, 97, 0.35)' },  // Salmon
    { norm: '#ffa600', light: 'rgba(255, 166, 0, 0.35)' }   // Orange
];

// Helper to get color by index (safe)
function getColor(idx, type) {
    const i = Math.min(idx, PALETTE.length - 1);
    return type === 'light' ? PALETTE[i].light : PALETTE[i].norm;
}

const METRIC_CONFIG = {
  'Latency': { dir: 'min', suffix: ' ms' },
  'Peak_VRAM': { dir: 'min', suffix: ' GB' },
  'Throughput': { dir: 'max', suffix: ' samples/s' },
  'Req_per_Sec': { dir: 'max', suffix: ' req/s' },
  'Tokens_per_Sec': { dir: 'max', suffix: ' tok/s' },
  'Output_Tokens_per_Sec': { dir: 'max', suffix: ' tok/s' },
  'BW_Est': { dir: 'max', suffix: ' GB/s' },
  'it_s': { dir: 'max', suffix: ' it/s' } // For Diffusion
};

function parseCSV(text) {
  if (!text || text.includes('<')) return [];
  const lines = text.trim().split(/\r?\n/);
  const headers = lines[0].split(',').map(h=>h.trim());
  return lines.slice(1).map(line => {
    const d = {};
    const row = line.split(',');
    headers.forEach((h,i) => {
      const val = row[i]?.trim();
      if (!isNaN(val) && val !== '') d[h] = Number(val);
      else d[h] = val;
    });
    return d;
  });
}

function prepInference(data) {
  return data.map(d => {
    let p2p = String(d.P2P_Enabled).toUpperCase();
    if(p2p === 'DEFAULT') p2p = 'YES';
    return { ...d, P2P_Norm: p2p === 'YES' ? 'Enabled' : 'Disabled' };
  });
}

const data8b = prepInference(parseCSV(CSV_8B));
const data70b = prepInference(parseCSV(CSV_70B));
const dataTrain = parseCSV(CSV_TRAIN).map(d => {
  let p2p = String(d.P2P_Enabled).toUpperCase();
  const norm = (p2p === 'NO' || p2p.includes('FALSE')) ? 'Disabled' : 'Enabled';
  return { ...d, P2P_Norm: norm };
});
// Diffusion data prep: flatten to array of objects
const rawDiff = parseCSV(CSV_DIFF);
const dataDiff = [];
if(rawDiff.length) {
    // Detect keys
    const k1 = Object.keys(rawDiff[0]).find(k => k.toLowerCase().includes('sdxl'));
    const k2 = Object.keys(rawDiff[0]).find(k => k.toLowerCase().includes('z-image'));
    rawDiff.forEach(r => {
        if(k1 && r[k1]) dataDiff.push({ GPU: r.GPU, Model: 'SDXL', Value: r[k1] });
        if(k2 && r[k2]) dataDiff.push({ GPU: r.GPU, Model: 'Z-Image', Value: r[k2] });
    });
}


// --- UI COMPONENTS ---

function createMultiSelect(id, label, options, defaultVals, onChange) {
  const container = document.getElementById(id);
  if(!container) return;
  container.innerHTML = `<label>${label}</label>`;

  const wrapper = document.createElement('div');
  wrapper.className = 'multi-select';

  const display = document.createElement('div');
  display.className = 'ms-display';
  
  const dropdown = document.createElement('div');
  dropdown.className = 'ms-dropdown';

  options.forEach(opt => {
    const row = document.createElement('label');
    row.className = 'ms-option';
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.value = opt;
    chk.checked = defaultVals.includes(opt);
    chk.addEventListener('change', () => {
      updateDisplay();
      onChange();
    });
    row.appendChild(chk);
    row.appendChild(document.createTextNode(opt));
    dropdown.appendChild(row);
  });

  function updateDisplay() {
    const checked = Array.from(dropdown.querySelectorAll('input:checked')).map(c => c.value);
    if(checked.length === 0) display.textContent = 'None';
    else if(checked.length === options.length) display.textContent = 'All';
    else display.textContent = checked.join(', ');
  }

  display.addEventListener('click', (e) => {
    e.stopPropagation();
    document.querySelectorAll('.ms-dropdown').forEach(d => {
      if(d !== dropdown) d.classList.remove('open');
    });
    dropdown.classList.toggle('open');
    display.classList.toggle('active');
  });

  document.addEventListener('click', (e) => {
    if(!wrapper.contains(e.target)) {
      dropdown.classList.remove('open');
      display.classList.remove('active');
    }
  });

  wrapper.appendChild(display);
  wrapper.appendChild(dropdown);
  container.appendChild(wrapper);
  updateDisplay();
  return () => Array.from(dropdown.querySelectorAll('input:checked')).map(c => c.value);
}

// --- LOGIC ---

let get8bGPU, get8bBatch, get8bP2P;
let get70bGPU, get70bBatch, get70bP2P;
let getTrainGPU, getTrainMode, getTrainBatch, getTrainSeq, getTrainP2P;
let getDiffGPU, getDiffModel;

function init() {
  // 8B
  const gpus8b = [...new Set(data8b.map(d=>d.GPU))].sort();
  const batch8b = [...new Set(data8b.map(d=>d.Batch))].sort((a,b)=>a-b);
  get8bGPU = createMultiSelect('ctrl-8b-gpu', 'GPU Model', gpus8b, gpus8b, update8b);
  get8bBatch = createMultiSelect('ctrl-8b-batch', 'Batch Size', batch8b, [1, 32], update8b);
  get8bP2P = createMultiSelect('ctrl-8b-p2p', 'NVLink State', ['Enabled', 'Disabled'], ['Enabled', 'Disabled'], update8b);
  document.getElementById('metric-8b').addEventListener('change', update8b);

  // 70B
  const gpus70b = [...new Set(data70b.map(d=>d.GPU))].sort();
  const batch70b = [...new Set(data70b.map(d=>d.Batch))].sort((a,b)=>a-b);
  get70bGPU = createMultiSelect('ctrl-70b-gpu', 'GPU Model', gpus70b, gpus70b, update70b);
  get70bBatch = createMultiSelect('ctrl-70b-batch', 'Batch Size', batch70b, [1, 32], update70b);
  get70bP2P = createMultiSelect('ctrl-70b-p2p', 'NVLink State', ['Enabled', 'Disabled'], ['Enabled', 'Disabled'], update70b);
  document.getElementById('metric-70b').addEventListener('change', update70b);

  // Training
  const gpusTrain = [...new Set(dataTrain.map(d=>d.GPU))].sort();
  const modesTrain = ['ddp', 'fsdp', 'tp'];
  const batchTrain = [...new Set(dataTrain.map(d=>d.Global_Batch))].sort((a,b)=>a-b);
  const seqTrain = [...new Set(dataTrain.map(d=>d.Seq_Len))].sort((a,b)=>a-b);
  getTrainGPU = createMultiSelect('ctrl-train-gpu', 'GPU Model', gpusTrain, gpusTrain, updateTrain);
  getTrainMode = createMultiSelect('ctrl-train-mode', 'Parallel Mode', modesTrain, modesTrain, updateTrain);
  getTrainBatch = createMultiSelect('ctrl-train-batch', 'Global Batch', batchTrain, batchTrain, updateTrain);
  getTrainSeq = createMultiSelect('ctrl-train-seq', 'Seq Length', seqTrain, seqTrain, updateTrain);
  getTrainP2P = createMultiSelect('ctrl-train-p2p', 'NVLink State', ['Enabled', 'Disabled'], ['Enabled', 'Disabled'], updateTrain);
  document.getElementById('metric-train').addEventListener('change', updateTrain);

  // Diffusion
  const gpusDiff = [...new Set(dataDiff.map(d=>d.GPU))].sort();
  const modelsDiff = ['SDXL', 'Z-Image'];
  getDiffGPU = createMultiSelect('ctrl-diff-gpu', 'GPU Model', gpusDiff, gpusDiff, updateDiff);
  getDiffModel = createMultiSelect('ctrl-diff-model', 'Model', modelsDiff, modelsDiff, updateDiff);

  // Initial Render
  if(data8b.length) update8b();
  if(data70b.length) update70b();
  if(dataTrain.length) updateTrain();
  if(dataDiff.length) updateDiff();
}

// --- CHART BUILDING ---

// Helper to add Custom Legend Traces
function getLegendTraces(activeTPs, showNVLink) {
    const traces = [];
    
    // 1. GPU Count Legend (Real Colors)
    activeTPs.forEach(tp => {
        const idx = [1, 2, 4, 8].indexOf(tp);
        if (idx === -1) return;
        traces.push({
            x: [null], y: [null],
            type: 'bar',
            name: `${tp} GPU${tp>1?'s':''}`,
            marker: { color: getColor(idx, 'norm') },
            showlegend: true
        });
    });

    // 2. NVLink Legend (Abstract Gray)
    if (showNVLink) {
        traces.push({
            x: [null], y: [null],
            type: 'bar',
            name: 'NVLink Enabled',
            marker: { color: '#666' }, // Dark Gray
            showlegend: true
        });
        traces.push({
            x: [null], y: [null],
            type: 'bar',
            name: 'NVLink Disabled',
            marker: { color: '#ccc' }, // Light Gray
            showlegend: true
        });
    }

    return traces;
}

function buildTraces(filteredData, metric, xLabelFn, isStacked) {
  const groups = {};
  const activeTPs = new Set();

  filteredData.forEach(d => {
    const label = xLabelFn(d);
    if(!groups[label]) groups[label] = { tp: d.TP || d.Num_GPUs || 1, enabled: null, disabled: null, row: d };
    
    let val = d[metric];
    if(typeof val !== 'number') val = 0;

    // Track active TPs for legend
    if (val > 0) activeTPs.add(groups[label].tp);

    if(d.P2P_Norm === 'Enabled') groups[label].enabled = val;
    else groups[label].disabled = val;
    
    // Fallback for TP1
    if(groups[label].tp === 1 && val > 0) {
        groups[label].enabled = val;
        groups[label].disabled = val;
    }
  });

  const labels = Object.keys(groups);
  if(labels.length === 0) return { traces: [], activeTPs: [] };

  const x = [];
  const yBase = []; // Bottom bar (Disabled)
  const yTop = [];  // Top bar (Delta)
  const cBase = [];
  const cTop = [];
  const txtTop = []; // Total Labels
  const hoverBase = [];
  const hoverTop = [];

  labels.forEach(lbl => {
    const g = groups[lbl];
    const idx = [1, 2, 4, 8].indexOf(g.tp);
    const colSolid = getColor(idx, 'norm');
    const colLight = getColor(idx, 'light');

    x.push(lbl);

    if (isStacked) {
      const baseVal = g.disabled || 0;
      const totalVal = g.enabled || 0;
      const delta = totalVal - baseVal;
      
      yBase.push(baseVal);
      yTop.push(delta > 0 ? delta : 0);
      
      cBase.push(colLight);
      cTop.push(colSolid);

      // Label on top is TOTAL
      txtTop.push(totalVal > 0 ? totalVal.toFixed(0) : '');

      hoverBase.push(`PCIe/No-NVLink: ${baseVal.toFixed(2)}`);
      hoverTop.push(`NVLink Gain: ${delta.toFixed(2)}<br>Total: ${totalVal.toFixed(2)}`);
    } else {
      const val = g.enabled !== null ? g.enabled : g.disabled;
      yBase.push(val);
      yTop.push(0);
      cBase.push(colSolid);
      txtTop.push(val > 0 ? val.toFixed(0) : '');
      hoverBase.push(`Value: ${val.toFixed(2)}`);
    }
  });

  const mainTraces = [];
  
  // Base Trace
  mainTraces.push({
    x: x, y: yBase, type: 'bar', marker: { color: cBase },
    text: isStacked ? yBase.map(v=>v>0?v.toFixed(0):'') : txtTop,
    textposition: 'auto',
    hovertemplate: '%{x}<br>%{customdata}<extra></extra>',
    customdata: hoverBase,
    showlegend: false
  });

  // Top Trace (Delta)
  if (isStacked) {
    mainTraces.push({
      x: x, y: yTop, type: 'bar', marker: { color: cTop },
      text: txtTop, 
      textposition: 'outside',
      hovertemplate: '%{x}<br>%{customdata}<extra></extra>',
      customdata: hoverTop,
      showlegend: false
    });
  }

  return { traces: mainTraces, activeTPs: Array.from(activeTPs).sort((a,b)=>a-b) };
}

function updateSummary(id, data, metric) {
  const container = document.getElementById(id);
  const conf = METRIC_CONFIG[metric] || { dir: 'max', suffix: '' };
  const isMin = conf.dir === 'min';

  // For summary, use single object per row (Diffusion is already flattened)
  const valid = data.filter(d => {
      let val = d[metric];
      if (d.Value !== undefined) val = d.Value; // Diffusion case
      return typeof val === 'number' && val > 0;
  });
  
  if(!valid.length) { container.style.display='none'; return; }

  valid.sort((a,b) => {
      let vA = a[metric]!==undefined?a[metric]:a.Value;
      let vB = b[metric]!==undefined?b[metric]:b.Value;
      return isMin ? vA - vB : vB - vA;
  });

  const best = valid[0];
  const worst = valid[valid.length-1];
  const bestVal = best[metric]!==undefined?best[metric]:best.Value;
  const worstVal = worst[metric]!==undefined?worst[metric]:worst.Value;

  const renderItem = (label, row, val) => `
    <div class="summary-item">
      ${label}: 
      <strong>${GPU_NAMES[row.GPU]||row.GPU}</strong> 
      ${row.TP?`(TP${row.TP})`:''} 
      ${row.Model?`(${row.Model})`:''} 
      ${row.Mode?`(${row.Mode})`:''} 
      <span class="summary-val">${val.toFixed(2)}${conf.suffix}</span>
    </div>`;

  container.innerHTML = `
    <div class="summary-title">Summary (${conf.dir === 'min' ? 'Lower' : 'Higher'} is Better)</div>
    <div class="summary-grid">
      ${renderItem('BEST CONFIG', best, bestVal)}
      ${renderItem('WORST CONFIG', worst, worstVal)}
    </div>
  `;
  container.style.display = 'flex';
}


// --- TAB UPDATERS ---

function update8b() {
  const gpu = get8bGPU();
  const batch = get8bBatch();
  const p2p = get8bP2P();
  const metric = document.getElementById('metric-8b').value;

  const filtered = data8b.filter(d => 
    gpu.includes(d.GPU) && 
    batch.includes(String(d.Batch)) &&
    p2p.includes(d.P2P_Norm)
  );

  const isStacked = p2p.includes('Enabled') && p2p.includes('Disabled');
  const showGpuLabel = gpu.length > 1;
  const labelFn = (d) => {
    let parts = [];
    if(showGpuLabel) parts.push(GPU_NAMES[d.GPU] || d.GPU);
    parts.push(`TP${d.TP}`);
    parts.push(`B${d.Batch}`);
    return parts.join(' ');
  };

  const { traces, activeTPs } = buildTraces(filtered, metric, labelFn, isStacked);
  const legendTraces = getLegendTraces(activeTPs, isStacked);

  Plotly.newPlot('chart-8b', [...traces, ...legendTraces], {
    barmode: isStacked ? 'relative' : 'group',
    margin: { l: 60, r: 20, t: 30, b: 100 },
    xaxis: { tickangle: -45 },
    yaxis: { title: metric },
    showlegend: true,
    legend: { orientation: 'h', y: 1.1 }
  }, {responsive: true});

  updateSummary('sum-8b', filtered, metric);
}

function update70b() {
  const gpu = get70bGPU();
  const batch = get70bBatch();
  const p2p = get70bP2P();
  const metric = document.getElementById('metric-70b').value;

  const filtered = data70b.filter(d => 
    gpu.includes(d.GPU) && 
    batch.includes(String(d.Batch)) &&
    p2p.includes(d.P2P_Norm)
  );

  const isStacked = p2p.includes('Enabled') && p2p.includes('Disabled');
  const showGpuLabel = gpu.length > 1;
  const labelFn = (d) => {
    let parts = [];
    if(showGpuLabel) parts.push(GPU_NAMES[d.GPU] || d.GPU);
    parts.push(`TP${d.TP}`);
    parts.push(`B${d.Batch}`);
    return parts.join(' ');
  };

  const { traces, activeTPs } = buildTraces(filtered, metric, labelFn, isStacked);
  const legendTraces = getLegendTraces(activeTPs, isStacked);

  Plotly.newPlot('chart-70b', [...traces, ...legendTraces], {
    barmode: isStacked ? 'relative' : 'group',
    margin: { l: 60, r: 20, t: 30, b: 100 },
    xaxis: { tickangle: -45 },
    yaxis: { title: metric },
    showlegend: true,
    legend: { orientation: 'h', y: 1.1 }
  }, {responsive: true});

  updateSummary('sum-70b', filtered, metric);
}

function updateTrain() {
  const gpu = getTrainGPU();
  const mode = getTrainMode();
  const batch = getTrainBatch();
  const seq = getTrainSeq();
  const p2p = getTrainP2P();
  const metric = document.getElementById('metric-train').value;

  const filtered = dataTrain.filter(d => {
    if(!gpu.includes(d.GPU)) return false;
    if(!batch.includes(String(d.Global_Batch))) return false;
    if(!seq.includes(String(d.Seq_Len))) return false;
    // Keep TP1 baseline if filters allow, else strict mode/p2p
    const isBaseline = d.Num_GPUs === 1;
    if (isBaseline) return true;
    if(!mode.includes(d.Mode)) return false;
    if(!p2p.includes(d.P2P_Norm)) return false;
    return true;
  });

  const isStacked = p2p.includes('Enabled') && p2p.includes('Disabled');
  const showGpu = gpu.length > 1;
  const showMode = mode.length > 1; 

  const labelFn = (d) => {
    let parts = [];
    if(showGpu) parts.push(GPU_NAMES[d.GPU] || d.GPU);
    if(d.Num_GPUs === 1) parts.push('1 GPU (Base)');
    else {
      if(showMode) parts.push(d.Mode.toUpperCase());
      parts.push(`${d.Num_GPUs} GPU`);
    }
    parts.push(`B${d.Global_Batch}`);
    parts.push(`S${d.Seq_Len}`);
    return parts.join(' ');
  };

  const { traces, activeTPs } = buildTraces(filtered, metric, labelFn, isStacked);
  const legendTraces = getLegendTraces(activeTPs, isStacked);

  Plotly.newPlot('chart-train', [...traces, ...legendTraces], {
    barmode: isStacked ? 'relative' : 'group',
    margin: { l: 60, r: 20, t: 30, b: 120 },
    xaxis: { tickangle: -45 },
    yaxis: { title: metric },
    showlegend: true,
    legend: { orientation: 'h', y: 1.1 }
  }, {responsive: true});

  updateSummary('sum-train', filtered, metric);
}

function updateDiff() {
  const gpus = getDiffGPU();
  const models = getDiffModel();
  
  if(!dataDiff.length) {
     document.getElementById('alert-diff').innerText = "No Diffusion Data";
     document.getElementById('alert-diff').style.display = 'block';
     return;
  }

  // Filter
  const filtered = dataDiff.filter(d => gpus.includes(d.GPU) && models.includes(d.Model));
  
  // Group by GPU
  const grouped = {};
  filtered.forEach(d => {
      if(!grouped[d.GPU]) grouped[d.GPU] = {};
      grouped[d.GPU][d.Model] = d.Value;
  });

  const xLabels = Object.keys(grouped);
  const traces = [];

  // Model 0 -> Color 0, Model 1 -> Color 1
  const allModels = ['SDXL', 'Z-Image']; // Fixed order for colors
  
  allModels.forEach((m, idx) => {
      if(!models.includes(m)) return;
      const y = xLabels.map(gpu => grouped[gpu][m] || 0);
      const trace = {
          x: xLabels.map(g => GPU_NAMES[g] || g),
          y: y,
          type: 'bar',
          name: m,
          marker: { color: getColor(idx, 'norm') },
          text: y.map(v => v.toFixed(2)),
          textposition: 'auto'
      };
	  
	  traces.push(trace);
	  
  });

  Plotly.newPlot('chart-diff', traces, {
    barmode: 'group',
    margin: { t: 30, b: 50 },
    yaxis: { title: 'Iterations / Sec' }
  }, {responsive: true});

  updateSummary('sum-diff', filtered, 'it_s');
}

function switchTab(id) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelector(`button[onclick="switchTab('${id}')"]`).classList.add('active');
  window.dispatchEvent(new Event('resize'));
}

window.addEventListener('load', init);

</script>
</body>
</html>
